pipeline {
    agent any
    tools {
        maven 'jenkins-maven'
        jdk 'jenkins-Java'
    }
    stages {
       
        stage('clone and maven Build') { 
      
            steps {
                
                echo 'Start clone ...'
				git branch: 'init-development', credentialsId: 'ajrahhal', url: 'https://ajrahhal@bitbucket.org/Digital_Cash/attachment-service.git'
				echo 'End clone ...'

				echo 'Start maven build ..'
				sh 'mvn --version'
                sh 'mvn -B -DskipTests clean package'
				echo 'Finish maven build ...'
				echo '$PATH'
            }
        }


        	stage("Stop and remove old build") {
// 			agent { label 'master' }
			steps {
				echo 'Start stop and remove old build ...'
				sh """
					( docker container stop attachment-service &&  docker container rm attachment-service &&  docker image rm attachment-service) || true
				"""
				echo 'End stop and remove old build ...'
			}
		}
    		stage("Docker build") {
    // 			agent { label 'master' }
    			steps {
    				echo 'Start building the application ...'
    				echo 'workspace directory'
    				sh """
    					pwd && docker build -t attachment-service .
    				"""
    				echo 'End building the application ...'
    			}
    		}
    		stage("Docker run") {
	//		agent { label 'master' }
			steps {
				echo 'Start running the application ...'
				sh """
					docker run -p 9097:9097  -e EUREKA_SERVER_ADDRESS=http://eurekaservice:8761/eureka -e ACTIVE_PROFILE=dev -d --name attachment-service attachment-service
				"""
				echo 'End running the application ...'
			}
		}

		stage("Docker connect build to eminetwork") {
// 			agent { label 'master' }
			steps {
				echo 'Start connect container to eminetwork ...'
				sh """
					((docker network create myNetwork) || true) && docker network connect myNetwork attachment-service
				"""
				sh"""
				docker system prune -f
				"""
				echo 'End connect container to eminetwork ...'
			}
		}
    }

}